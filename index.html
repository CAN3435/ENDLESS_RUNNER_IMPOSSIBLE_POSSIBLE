<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Endless Runner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        
        /* UI Overlay */
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        #score {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 32px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            pointer-events: none;
        }
        
        #playerName {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            pointer-events: none;
        }
        
        /* Start Screen */
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: all;
        }
        
        #startScreen h1 {
            font-size: 48px;
            color: #FFD700;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.7);
        }
        
        #startScreen p {
            font-size: 18px;
            color: white;
            margin-bottom: 30px;
            text-align: center;
            max-width: 80%;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            color: white;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .input-group input {
            padding: 12px 20px;
            font-size: 18px;
            border: none;
            border-radius: 25px;
            width: 300px;
            max-width: 80vw;
            text-align: center;
            pointer-events: all;
        }
        
        .btn {
            padding: 15px 40px;
            font-size: 24px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s;
            pointer-events: all;
            margin: 10px;
        }
        
        .btn:hover {
            transform: scale(1.1);
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        /* Game Over Screen */
        #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: all;
            overflow-y: auto;
        }
        
        #gameOverScreen h2 {
            font-size: 56px;
            color: #ff6b6b;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.7);
        }
        
        #finalScore {
            font-size: 32px;
            color: #FFD700;
            margin-bottom: 30px;
        }
        
        /* Leaderboard */
        #leaderboardScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            pointer-events: all;
            overflow-y: auto;
            padding: 40px 20px;
        }
        
        #leaderboardScreen h2 {
            font-size: 48px;
            color: #FFD700;
            margin-bottom: 30px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.7);
        }
        
        .leaderboard-list {
            width: 90%;
            max-width: 500px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            color: white;
            font-size: 20px;
        }
        
        .leaderboard-item.top1 {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            font-weight: bold;
            transform: scale(1.05);
        }
        
        .leaderboard-item.top2 {
            background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%);
            color: #000;
        }
        
        .leaderboard-item.top3 {
            background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
            color: #fff;
        }
        
        .rank {
            font-size: 24px;
            font-weight: bold;
            min-width: 40px;
        }
        
        .player-info {
            flex: 1;
            margin: 0 15px;
        }
        
        .score-value {
            font-size: 22px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui">
        <div id="score">Score: 0</div>
        <div id="playerName"></div>
        
        <div id="startScreen">
            <h1>üèÉ ENDLESS RUNNER üèÉ</h1>
            <p>Desktop: Arrow Keys or A/D to move, Space to jump<br>Mobile: Tap sides to move, swipe up to jump</p>
            
            <div class="input-group">
                <label for="nameInput">Adƒ±nƒ±zƒ± Girin:</label>
                <input type="text" id="nameInput" placeholder="Oyuncu Adƒ±" maxlength="15">
            </div>
            
            <button class="btn" id="startBtn">OYUNA BA≈ûLA</button>
            <button class="btn btn-secondary" id="viewLeaderboardBtn">Lƒ∞DER TABLOSU</button>
        </div>
        
        <div id="gameOverScreen">
            <h2>OYUN Bƒ∞TTƒ∞!</h2>
            <div id="finalScore">Final Skor: 0</div>
            <button class="btn" id="restartBtn">TEKRAR OYNA</button>
            <button class="btn btn-secondary" id="viewLeaderboardBtn2">Lƒ∞DER TABLOSU</button>
        </div>
        
        <div id="leaderboardScreen">
            <h2>üèÜ Lƒ∞DER TABLOSU üèÜ</h2>
            <div class="leaderboard-list" id="leaderboardList"></div>
            <button class="btn" id="backToMenuBtn">ANA MEN√ú</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Game state
        let scene, camera, renderer;
        let player, ground, obstacles = [], coins = [];
        let gameState = 'start'; // 'start', 'playing', 'gameOver', 'leaderboard'
        let score = 0;
        let speed = 0.2;
        let obstacleSpawnTimer = 0;
        let coinSpawnTimer = 0;
        let distanceScore = 0;
        let playerName = '';
        
        // Player properties
        const lanes = [-2, 0, 2];
        let currentLane = 1;
        let playerTargetX = lanes[currentLane];
        let isJumping = false;
        let jumpVelocity = 0;
        const gravity = -0.02;
        const jumpPower = 0.3;
        
        // Mobile touch handling
        let touchStartX = 0;
        let touchStartY = 0;
        
        // Leaderboard management using persistent storage
        async function loadLeaderboard() {
            try {
                const result = await window.storage.get('leaderboard', true);
                return result ? JSON.parse(result.value) : [];
            } catch (error) {
                return [];
            }
        }
        
        async function saveLeaderboard(leaderboard) {
            try {
                await window.storage.set('leaderboard', JSON.stringify(leaderboard), true);
            } catch (error) {
                console.error('Leaderboard save error:', error);
            }
        }
        
        async function addToLeaderboard(name, score) {
            const leaderboard = await loadLeaderboard();
            leaderboard.push({ name, score, date: new Date().toISOString() });
            leaderboard.sort((a, b) => b.score - a.score);
            const top10 = leaderboard.slice(0, 10);
            await saveLeaderboard(top10);
            return top10;
        }
        
        async function displayLeaderboard() {
            const leaderboard = await loadLeaderboard();
            const listElement = document.getElementById('leaderboardList');
            
            if (leaderboard.length === 0) {
                listElement.innerHTML = '<div class="leaderboard-item" style="justify-content: center;">Hen√ºz skor yok. ƒ∞lk sen ol!</div>';
                return;
            }
            
            listElement.innerHTML = leaderboard.map((entry, index) => {
                let className = 'leaderboard-item';
                let medal = '';
                if (index === 0) {
                    className += ' top1';
                    medal = 'ü•á';
                } else if (index === 1) {
                    className += ' top2';
                    medal = 'ü•à';
                } else if (index === 2) {
                    className += ' top3';
                    medal = 'ü•â';
                }
                
                return `
                    <div class="${className}">
                        <span class="rank">${medal || (index + 1)}</span>
                        <span class="player-info">${entry.name}</span>
                        <span class="score-value">${entry.score}</span>
                    </div>
                `;
            }).join('');
        }
        
        // Initialize Three.js scene
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.Fog(0x87CEEB, 10, 50);
            
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 3, 5);
            camera.lookAt(0, 1, 0);
            
            const canvas = document.getElementById('gameCanvas');
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 5);
            scene.add(directionalLight);
            
            createGround();
            createPlayer();
            
            window.addEventListener('resize', onWindowResize);
            document.addEventListener('keydown', onKeyDown);
            canvas.addEventListener('touchstart', onTouchStart);
            canvas.addEventListener('touchend', onTouchEnd);
            canvas.addEventListener('click', onCanvasClick);
            
            document.getElementById('startBtn').addEventListener('click', startGame);
            document.getElementById('restartBtn').addEventListener('click', restartGame);
            document.getElementById('viewLeaderboardBtn').addEventListener('click', showLeaderboard);
            document.getElementById('viewLeaderboardBtn2').addEventListener('click', showLeaderboard);
            document.getElementById('backToMenuBtn').addEventListener('click', backToMenu);
            
            // Auto-focus name input
            document.getElementById('nameInput').focus();
        }
        
        function createGround() {
            const geometry = new THREE.PlaneGeometry(10, 100);
            const material = new THREE.MeshLambertMaterial({ color: 0x228B22 });
            ground = new THREE.Mesh(geometry, material);
            ground.rotation.x = -Math.PI / 2;
            ground.position.z = -25;
            scene.add(ground);
            
            for (let lane of lanes) {
                const lineGeometry = new THREE.BoxGeometry(0.1, 0.1, 100);
                const lineMaterial = new THREE.MeshLambertMaterial({ color: 0xFFFFFF });
                const line = new THREE.Mesh(lineGeometry, lineMaterial);
                line.position.set(lane - 1, 0.05, -25);
                scene.add(line);
            }
        }
        
        function createPlayer() {
            const geometry = new THREE.BoxGeometry(0.8, 1.5, 0.8);
            const material = new THREE.MeshLambertMaterial({ color: 0xFF4500 });
            player = new THREE.Mesh(geometry, material);
            player.position.set(lanes[currentLane], 0.75, 0);
            scene.add(player);
        }
        
        function createObstacle() {
            const colors = [0xFF0000, 0x8B4513, 0x4B0082, 0xFF1493];
            const geometry = new THREE.BoxGeometry(1, 1.5, 1);
            const material = new THREE.MeshLambertMaterial({ 
                color: colors[Math.floor(Math.random() * colors.length)] 
            });
            const obstacle = new THREE.Mesh(geometry, material);
            const randomLane = lanes[Math.floor(Math.random() * lanes.length)];
            obstacle.position.set(randomLane, 0.75, -30);
            scene.add(obstacle);
            obstacles.push(obstacle);
        }
        
        function createCoin() {
            const geometry = new THREE.SphereGeometry(0.3, 16, 16);
            const material = new THREE.MeshLambertMaterial({ color: 0xFFD700 });
            const coin = new THREE.Mesh(geometry, material);
            const randomLane = lanes[Math.floor(Math.random() * lanes.length)];
            coin.position.set(randomLane, 1.5, -30);
            scene.add(coin);
            coins.push(coin);
        }
        
        function startGame() {
            const nameInput = document.getElementById('nameInput').value.trim();
            if (!nameInput) {
                alert('L√ºtfen bir isim girin!');
                return;
            }
            
            playerName = nameInput;
            gameState = 'playing';
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('playerName').textContent = 'üë§ ' + playerName;
            score = 0;
            speed = 0.2;
            distanceScore = 0;
            updateScore();
        }
        
        async function restartGame() {
            const nameInput = document.getElementById('nameInput').value.trim();
            if (nameInput) {
                playerName = nameInput;
            }
            
            gameState = 'playing';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('playerName').textContent = 'üë§ ' + playerName;
            
            currentLane = 1;
            playerTargetX = lanes[currentLane];
            player.position.set(lanes[currentLane], 0.75, 0);
            isJumping = false;
            jumpVelocity = 0;
            
            obstacles.forEach(obs => scene.remove(obs));
            coins.forEach(coin => scene.remove(coin));
            obstacles = [];
            coins = [];
            
            score = 0;
            speed = 0.2;
            distanceScore = 0;
            obstacleSpawnTimer = 0;
            coinSpawnTimer = 0;
            updateScore();
        }
        
        async function gameOver() {
            gameState = 'gameOver';
            document.getElementById('finalScore').textContent = `Final Skor: ${score}`;
            document.getElementById('gameOverScreen').style.display = 'flex';
            
            // Add to leaderboard
            await addToLeaderboard(playerName, score);
        }
        
        async function showLeaderboard() {
            gameState = 'leaderboard';
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('leaderboardScreen').style.display = 'flex';
            await displayLeaderboard();
        }
        
        function backToMenu() {
            gameState = 'start';
            document.getElementById('leaderboardScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
        }
        
        function updateScore() {
            document.getElementById('score').textContent = `Skor: ${score}`;
        }
        
        function onKeyDown(e) {
            if (gameState !== 'playing') return;
            
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                moveLane(-1);
            } else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                moveLane(1);
            } else if (e.key === ' ' && !isJumping) {
                jump();
            }
        }
        
        function onTouchStart(e) {
            if (gameState !== 'playing') return;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }
        
        function onTouchEnd(e) {
            if (gameState !== 'playing') return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            
            if (Math.abs(deltaY) > Math.abs(deltaX) && deltaY < -50 && !isJumping) {
                jump();
            }
        }
        
        function onCanvasClick(e) {
            if (gameState !== 'playing') return;
            const clickX = e.clientX || (e.touches && e.touches[0].clientX);
            if (clickX < window.innerWidth / 2) {
                moveLane(-1);
            } else {
                moveLane(1);
            }
        }
        
        function moveLane(direction) {
            currentLane = Math.max(0, Math.min(2, currentLane + direction));
            playerTargetX = lanes[currentLane];
        }
        
        function jump() {
            if (!isJumping) {
                isJumping = true;
                jumpVelocity = jumpPower;
            }
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            if (gameState === 'playing') {
                player.position.x += (playerTargetX - player.position.x) * 0.2;
                
                if (isJumping) {
                    jumpVelocity += gravity;
                    player.position.y += jumpVelocity;
                    
                    if (player.position.y <= 0.75) {
                        player.position.y = 0.75;
                        isJumping = false;
                        jumpVelocity = 0;
                    }
                }
                
                player.rotation.y += 0.05;
                
                for (let i = obstacles.length - 1; i >= 0; i--) {
                    obstacles[i].position.z += speed;
                    
                    if (obstacles[i].position.z > 5) {
                        scene.remove(obstacles[i]);
                        obstacles.splice(i, 1);
                        continue;
                    }
                    
                    if (Math.abs(obstacles[i].position.z - player.position.z) < 1 &&
                        Math.abs(obstacles[i].position.x - player.position.x) < 0.8 &&
                        player.position.y < 1.5) {
                        gameOver();
                    }
                }
                
                for (let i = coins.length - 1; i >= 0; i--) {
                    coins[i].position.z += speed;
                    coins[i].rotation.y += 0.1;
                    
                    if (coins[i].position.z > 5) {
                        scene.remove(coins[i]);
                        coins.splice(i, 1);
                        continue;
                    }
                    
                    if (Math.abs(coins[i].position.z - player.position.z) < 1 &&
                        Math.abs(coins[i].position.x - player.position.x) < 0.8) {
                        score += 10;
                        updateScore();
                        scene.remove(coins[i]);
                        coins.splice(i, 1);
                    }
                }
                
                obstacleSpawnTimer++;
                if (obstacleSpawnTimer > 60 / speed) {
                    createObstacle();
                    obstacleSpawnTimer = 0;
                }
                
                coinSpawnTimer++;
                if (coinSpawnTimer > 40 / speed) {
                    createCoin();
                    coinSpawnTimer = 0;
                }
                
                speed = Math.min(0.6, speed + 0.0002);
                
                distanceScore++;
                if (distanceScore % 100 === 0) {
                    score += 1;
                    updateScore();
                }
                
                ground.position.z += speed;
                if (ground.position.z > 25) {
                    ground.position.z = -25;
                }
            }
            
            renderer.render(scene, camera);
        }
        
        init();
        animate();
    </script>
</body>
</html>
